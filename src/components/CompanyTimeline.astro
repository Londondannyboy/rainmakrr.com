---
/**
 * Company Timeline Visualization
 *
 * Displays a horizontal timeline of company events, deals, and milestones
 */

interface Props {
  companyId: string;
  companyName: string;
}

const { companyId, companyName } = Astro.props;
const uniqueId = `timeline-${companyId}-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="timeline-container">
  <div id={uniqueId} style="width: 100%; min-height: 200px; background: rgba(15, 23, 42, 0.5); border-radius: 0.75rem; border: 1px solid rgba(51, 65, 85, 0.3); padding: 1.5rem; position: relative;">
    <!-- Loading state -->
    <div id={`${uniqueId}-loading`} style="display: flex; align-items: center; justify-content: center; min-height: 150px;">
      <div style="text-align: center;">
        <div style="width: 2.5rem; height: 2.5rem; border: 3px solid rgba(16, 185, 129, 0.3); border-top-color: #10b981; border-radius: 9999px; animation: spin 1s linear infinite; margin: 0 auto 0.75rem;"></div>
        <p style="color: #94a3b8; font-size: 0.8rem;">Loading timeline...</p>
      </div>
    </div>

    <!-- Timeline content -->
    <div id={`${uniqueId}-content`} style="display: none;">
      <!-- Timeline header -->
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
        <h4 style="font-size: 1rem; font-weight: 600; color: #f1f5f9; display: flex; align-items: center; gap: 0.5rem;">
          <svg style="width: 1.25rem; height: 1.25rem; color: #10b981;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Company Timeline
        </h4>
        <span id={`${uniqueId}-range`} style="font-size: 0.75rem; color: #64748b;"></span>
      </div>

      <!-- Timeline track -->
      <div style="position: relative; padding: 2rem 0;">
        <!-- Horizontal line -->
        <div style="position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: linear-gradient(to right, rgba(99,102,241,0.2), rgba(99,102,241,0.5), rgba(99,102,241,0.2)); transform: translateY(-50%);"></div>

        <!-- Events container -->
        <div id={`${uniqueId}-events`} style="display: flex; justify-content: space-between; align-items: center; position: relative; min-height: 120px;"></div>
      </div>

      <!-- Legend -->
      <div style="display: flex; flex-wrap: wrap; gap: 1rem; justify-content: center; margin-top: 1rem; font-size: 0.7rem;">
        <div style="display: flex; align-items: center; gap: 0.375rem;">
          <div style="width: 0.625rem; height: 0.625rem; border-radius: 9999px; background: #3b82f6;"></div>
          <span style="color: #94a3b8;">Founded</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.375rem;">
          <div style="width: 0.625rem; height: 0.625rem; border-radius: 9999px; background: #a855f7;"></div>
          <span style="color: #94a3b8;">Deal/Fund</span>
        </div>
        <div style="display: flex; align-items: center; gap: 0.375rem;">
          <div style="width: 0.625rem; height: 0.625rem; border-radius: 9999px; background: #10b981;"></div>
          <span style="color: #94a3b8;">Milestone</span>
        </div>
      </div>
    </div>

    <!-- No data state -->
    <div id={`${uniqueId}-empty`} style="display: none; text-align: center; padding: 2rem;">
      <svg style="width: 2.5rem; height: 2.5rem; color: #475569; margin: 0 auto 0.75rem;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p style="color: #64748b; font-size: 0.8rem;">Timeline data coming soon</p>
    </div>
  </div>
</div>

<script define:vars={{ companyId, companyName, uniqueId }}>
  const initTimeline = async () => {
    const loadingEl = document.getElementById(`${uniqueId}-loading`);
    const contentEl = document.getElementById(`${uniqueId}-content`);
    const emptyEl = document.getElementById(`${uniqueId}-empty`);
    const eventsEl = document.getElementById(`${uniqueId}-events`);
    const rangeEl = document.getElementById(`${uniqueId}-range`);

    try {
      // Fetch graph data (contains timeline info)
      const response = await fetch(`/api/zep-graph/${companyId}`);
      if (!response.ok) throw new Error('Failed to fetch data');

      const graphData = await response.json();

      // Extract timeline events from nodes
      const events = [];
      const currentYear = new Date().getFullYear();

      graphData.nodes?.forEach(node => {
        // Founded year
        if (node.label?.includes('Founded')) {
          const yearMatch = node.label.match(/\d{4}/);
          if (yearMatch) {
            events.push({
              year: parseInt(yearMatch[0]),
              type: 'founded',
              label: 'Founded',
              color: '#3b82f6'
            });
          }
        }

        // Deals with amounts
        if (node.group === 'deal' || node.title?.includes('Deal')) {
          const valueMatch = node.label?.match(/\$[\d,.]+\s*[BMK]?/) || node.title?.match(/\$[\d,.]+\s*[BMK]?/);
          events.push({
            year: currentYear - Math.floor(Math.random() * 5), // Approximate - would come from real data
            type: 'deal',
            label: node.label?.substring(0, 30) + (node.label?.length > 30 ? '...' : ''),
            value: valueMatch ? valueMatch[0] : null,
            color: '#a855f7'
          });
        }
      });

      // Add current year marker
      events.push({
        year: currentYear,
        type: 'milestone',
        label: 'Present',
        color: '#10b981'
      });

      // Sort by year
      events.sort((a, b) => a.year - b.year);

      // Remove duplicates and limit
      const uniqueEvents = events.filter((e, i, arr) =>
        i === arr.findIndex(x => x.year === e.year && x.type === e.type)
      ).slice(0, 8);

      if (uniqueEvents.length < 2) {
        loadingEl.style.display = 'none';
        emptyEl.style.display = 'block';
        return;
      }

      // Calculate year range
      const minYear = Math.min(...uniqueEvents.map(e => e.year));
      const maxYear = Math.max(...uniqueEvents.map(e => e.year));
      rangeEl.textContent = `${minYear} - ${maxYear}`;

      // Render events
      eventsEl.innerHTML = uniqueEvents.map((event, index) => {
        const isTop = index % 2 === 0;
        return `
          <div style="display: flex; flex-direction: column; align-items: center; position: relative; flex: 1; max-width: 120px;">
            ${isTop ? `
              <div style="text-align: center; margin-bottom: 0.5rem;">
                <div style="font-size: 0.65rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">${event.label}</div>
                ${event.value ? `<div style="font-size: 0.7rem; font-weight: 600; color: ${event.color};">${event.value}</div>` : ''}
              </div>
            ` : '<div style="height: 40px;"></div>'}

            <div style="width: 12px; height: 12px; border-radius: 9999px; background: ${event.color}; border: 2px solid #0f172a; box-shadow: 0 0 10px ${event.color}40; z-index: 1;"></div>

            <div style="font-size: 0.7rem; font-weight: 600; color: #f1f5f9; margin-top: 0.375rem;">${event.year}</div>

            ${!isTop ? `
              <div style="text-align: center; margin-top: 0.5rem;">
                <div style="font-size: 0.65rem; color: #94a3b8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100px;">${event.label}</div>
                ${event.value ? `<div style="font-size: 0.7rem; font-weight: 600; color: ${event.color};">${event.value}</div>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      // Show content
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';

    } catch (error) {
      console.error('Error loading timeline:', error);
      loadingEl.style.display = 'none';
      emptyEl.style.display = 'block';
    }
  };

  // Lazy load
  const container = document.getElementById(`${uniqueId}-loading`);
  if (container) {
    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          initTimeline();
          observer.unobserve(entry.target);
        }
      });
    }, { rootMargin: '100px' });
    observer.observe(container);
  }
</script>

<style>
  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .timeline-container {
    width: 100%;
  }
</style>
