---
/**
 * HeroVideo Component
 * Full-width video hero with title overlay
 * Uses HLS.js for cross-browser video playback
 *
 * @prop playbackId - Mux playback ID
 * @prop title - Article title
 * @prop excerpt - Article excerpt/description
 * @prop articleAngle - Article type badge (e.g., "news", "analysis")
 */
interface Props {
  playbackId: string;
  title: string;
  excerpt?: string;
  articleAngle?: string;
}

const { playbackId, title, excerpt, articleAngle } = Astro.props;

const hlsUrl = `https://stream.mux.com/${playbackId}.m3u8`;
const posterUrl = `https://image.mux.com/${playbackId}/thumbnail.jpg?time=1.5&width=1920`;
---

<header class="relative bg-gray-900 overflow-hidden">
  <div class="max-w-7xl mx-auto">
    <div class="relative aspect-video">
      <video
        id="hero-video"
        class="w-full h-full object-cover"
        muted
        autoplay
        loop
        playsinline
        poster={posterUrl}
        data-hls-src={hlsUrl}
      ></video>
      <!-- Gradient overlay -->
      <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent"></div>

      <!-- Content overlay -->
      <div class="absolute bottom-0 left-0 right-0 p-6 md:p-10">
        <div class="max-w-4xl">
          {articleAngle && (
            <span class="inline-block bg-blue-600/80 backdrop-blur-sm text-white text-xs font-semibold uppercase tracking-wider px-3 py-1.5 rounded mb-4">
              {articleAngle}
            </span>
          )}
          <h1 class="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight drop-shadow-lg">
            {title}
          </h1>
          {excerpt && (
            <p class="text-lg md:text-xl text-gray-200 max-w-3xl drop-shadow">
              {excerpt}
            </p>
          )}
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  // Initialize HLS video for hero
  document.addEventListener('DOMContentLoaded', () => {
    const video = document.getElementById('hero-video') as HTMLVideoElement;
    if (!video) return;

    const hlsSrc = video.dataset.hlsSrc;
    if (!hlsSrc) return;

    // Check for native HLS support (Safari)
    if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = hlsSrc;
      video.play().catch(() => {});
    } else if (typeof Hls !== 'undefined' && Hls.isSupported()) {
      // Use HLS.js for other browsers
      const hls = new Hls({ maxBufferLength: 30 });
      hls.loadSource(hlsSrc);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play().catch(() => {});
      });
    } else {
      // Fallback to poster image
      console.log('HLS not supported, using poster image');
    }
  });
</script>
