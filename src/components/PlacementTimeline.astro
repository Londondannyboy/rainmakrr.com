---
/**
 * Placement Timeline Component
 *
 * Beautiful vertical timeline showing deals and news events
 * Each item is clickable and links to the article
 */

interface Props {
  maxItems?: number;
}

const { maxItems = 12 } = Astro.props;

import { sql } from '../lib/db';

// Fetch recent articles with deal indicators
const articlesRaw = await sql`
  SELECT
    id, title, slug, article_angle,
    published_at, created_at,
    meta_description,
    payload->>'timeline' as timeline_json
  FROM articles
  WHERE app = 'rainmakrr' AND status = 'published'
  ORDER BY COALESCE(published_at, created_at) DESC
  LIMIT ${maxItems}
`;

// Categorize articles
const articles = articlesRaw.map((a: any) => {
  const title = a.title || '';
  const isDeal = /acqui|merger|buyout|investment|raises|funding|stake|exit|billion|\$[\d]+/i.test(title);
  const isEvent = /launch|announc|partner|expand|appoint|hire|join/i.test(title);

  // Extract value if present
  let value = '';
  const valueMatch = title.match(/\$[\d,.]+\s*([BMK]illion)?|€[\d,.]+\s*([BMK]illion)?|£[\d,.]+\s*([BMK]illion)?/i);
  if (valueMatch) {
    value = valueMatch[0];
  }

  return {
    ...a,
    isDeal,
    isEvent,
    value,
    type: isDeal ? 'deal' : isEvent ? 'event' : 'news',
    date: a.published_at || a.created_at
  };
});
---

<div class="placement-timeline">
  <div class="timeline-header">
    <div class="timeline-icon">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
    </div>
    <div>
      <h3>Placement Timeline</h3>
      <p>Recent deals, events & news</p>
    </div>
  </div>

  <div class="timeline-track">
    {articles.map((article: any, index: number) => (
      <a href={`/${article.slug}`} class="timeline-item" data-type={article.type}>
        <div class="timeline-connector">
          <div class="timeline-dot" data-type={article.type}></div>
          {index < articles.length - 1 && <div class="timeline-line"></div>}
        </div>
        <div class="timeline-content">
          <div class="timeline-meta">
            <span class={`timeline-badge badge-${article.type}`}>
              {article.type === 'deal' ? 'Deal' : article.type === 'event' ? 'Event' : 'News'}
            </span>
            {article.value && <span class="timeline-value">{article.value}</span>}
            <span class="timeline-date">
              {new Date(article.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
            </span>
          </div>
          <h4 class="timeline-title">{article.title}</h4>
        </div>
        <svg class="timeline-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    ))}
  </div>

  <a href="/private-equity-placement-agent-news" class="timeline-footer">
    <span>View All News</span>
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
    </svg>
  </a>
</div>

<style>
  .placement-timeline {
    background: linear-gradient(135deg, #0f172a, #1e1b4b);
    border: 1px solid rgba(99, 102, 241, 0.3);
    border-radius: 1rem;
    padding: 1.5rem;
    color: #fff;
  }

  .timeline-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(99, 102, 241, 0.2);
  }

  .timeline-icon {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.75rem;
    background: linear-gradient(135deg, #6366f1, #8b5cf6);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .timeline-icon svg {
    width: 1.25rem;
    height: 1.25rem;
    color: #fff;
  }

  .timeline-header h3 {
    font-size: 1.1rem;
    font-weight: 700;
    margin: 0;
  }

  .timeline-header p {
    font-size: 0.75rem;
    color: #94a3b8;
    margin: 0;
  }

  .timeline-track {
    display: flex;
    flex-direction: column;
    gap: 0;
  }

  .timeline-item {
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    padding: 0.75rem;
    margin-left: 0;
    border-radius: 0.5rem;
    transition: all 0.2s;
    text-decoration: none;
    color: inherit;
  }

  .timeline-item:hover {
    background: rgba(99, 102, 241, 0.1);
  }

  .timeline-connector {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 20px;
    flex-shrink: 0;
  }

  .timeline-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #0f172a;
    flex-shrink: 0;
    position: relative;
    z-index: 1;
  }

  .timeline-dot[data-type="deal"] {
    background: #ef4444;
    box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
  }

  .timeline-dot[data-type="event"] {
    background: #f59e0b;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.5);
  }

  .timeline-dot[data-type="news"] {
    background: #3b82f6;
    box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
  }

  .timeline-line {
    width: 2px;
    flex-grow: 1;
    min-height: 30px;
    background: linear-gradient(to bottom, rgba(99, 102, 241, 0.4), rgba(99, 102, 241, 0.1));
    margin-top: 4px;
  }

  .timeline-content {
    flex: 1;
    min-width: 0;
  }

  .timeline-meta {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.375rem;
    flex-wrap: wrap;
  }

  .timeline-badge {
    font-size: 0.65rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 100px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .badge-deal {
    background: rgba(239, 68, 68, 0.2);
    color: #fca5a5;
  }

  .badge-event {
    background: rgba(245, 158, 11, 0.2);
    color: #fcd34d;
  }

  .badge-news {
    background: rgba(59, 130, 246, 0.2);
    color: #93c5fd;
  }

  .timeline-value {
    font-size: 0.7rem;
    font-weight: 700;
    color: #10b981;
  }

  .timeline-date {
    font-size: 0.65rem;
    color: #64748b;
    margin-left: auto;
  }

  .timeline-title {
    font-size: 0.85rem;
    font-weight: 600;
    color: #f1f5f9;
    margin: 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .timeline-item:hover .timeline-title {
    color: #fff;
  }

  .timeline-arrow {
    width: 1rem;
    height: 1rem;
    color: #64748b;
    flex-shrink: 0;
    margin-top: 0.25rem;
    opacity: 0;
    transform: translateX(-4px);
    transition: all 0.2s;
  }

  .timeline-item:hover .timeline-arrow {
    opacity: 1;
    transform: translateX(0);
    color: #6366f1;
  }

  .timeline-footer {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(99, 102, 241, 0.2);
    font-size: 0.85rem;
    font-weight: 600;
    color: #6366f1;
    text-decoration: none;
    transition: color 0.2s;
  }

  .timeline-footer:hover {
    color: #818cf8;
  }

  .timeline-footer svg {
    width: 1rem;
    height: 1rem;
  }
</style>
