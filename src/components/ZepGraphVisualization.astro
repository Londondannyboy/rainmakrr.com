---
/**
 * Zep Knowledge Graph Visualization Component
 *
 * Renders an interactive network graph showing company connections
 * using vis-network library
 */

interface Props {
  companyId: string;
  companyName: string;
}

const { companyId, companyName } = Astro.props;
---

<div class="zep-graph-container">
  <div id="zep-graph" class="w-full h-96 bg-slate-900/50 rounded-xl border border-slate-700/30 relative">
    <!-- Loading state -->
    <div id="graph-loading" class="absolute inset-0 flex items-center justify-center">
      <div class="text-center">
        <div class="w-12 h-12 border-4 border-emerald-500/30 border-t-emerald-500 rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-slate-400 text-sm">Loading knowledge graph...</p>
      </div>
    </div>

    <!-- Error state -->
    <div id="graph-error" class="absolute inset-0 hidden flex-col items-center justify-center p-6 text-center">
      <svg class="w-12 h-12 text-slate-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <p class="text-slate-400 text-sm">Knowledge graph visualization coming soon</p>
      <p class="text-slate-500 text-xs mt-2">Building connections...</p>
    </div>

    <!-- Graph canvas -->
    <div id="graph-network" class="w-full h-full"></div>
  </div>

  <!-- Graph legend -->
  <div class="mt-4 flex items-center justify-center gap-6 text-xs">
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full bg-blue-500"></div>
      <span class="text-slate-400">Companies</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full bg-purple-500"></div>
      <span class="text-slate-400">Deals</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
      <span class="text-slate-400">People</span>
    </div>
  </div>
</div>

<!-- vis-network library from CDN -->
<script is:inline src="https://unpkg.com/vis-network@9.1.9/standalone/umd/vis-network.min.js"></script>

<script define:vars={{ companyId, companyName }}>
  // Wait for vis-network to load
  window.addEventListener('DOMContentLoaded', async () => {
    const loadingEl = document.getElementById('graph-loading');
    const errorEl = document.getElementById('graph-error');
    const networkEl = document.getElementById('graph-network');

    try {
      // Fetch graph data from API endpoint
      const response = await fetch(`/api/zep-graph/${companyId}`);

      if (!response.ok) {
        throw new Error('Failed to fetch graph data');
      }

      const graphData = await response.json();

      // Check response type - Priority: video > data > screenshot

      // Handle 3D video (Attempt #2)
      if (graphData.type === 'video' && graphData.video_url) {
        loadingEl.classList.add('hidden');
        networkEl.innerHTML = `
          <video
            autoplay
            loop
            muted
            playsinline
            class="w-full h-full object-contain rounded-xl"
            style="background: #0f172a;"
          >
            <source src="${graphData.video_url}" type="video/webm" />
            Your browser does not support video playback.
          </video>
        `;
        networkEl.classList.remove('hidden');
        return;
      }

      // Handle screenshot (Attempt #3)
      if (graphData.type === 'screenshot' && graphData.screenshot_url) {
        loadingEl.classList.add('hidden');
        networkEl.innerHTML = `
          <img
            src="${graphData.screenshot_url}"
            alt="Zep Knowledge Graph for ${companyName}"
            class="w-full h-full object-contain rounded-xl"
            style="background: #0f172a;"
          />
        `;
        networkEl.classList.remove('hidden');
        return;
      }

      // Handle interactive data (Attempt #1)
      if (!graphData.nodes || graphData.nodes.length === 0) {
        // No data - show coming soon message
        loadingEl.classList.add('hidden');
        errorEl.classList.remove('hidden');
        errorEl.classList.add('flex');
        return;
      }

      // Hide loading, show graph
      loadingEl.classList.add('hidden');
      networkEl.classList.remove('hidden');

      // Create vis-network
      const nodes = new vis.DataSet(graphData.nodes.map(node => {
        const hasArticle = node.hasArticle || node.url || node.group === 'company' || node.group === 'article';

        return {
          id: node.id,
          label: node.label,
          group: node.group || 'default',
          title: node.title || node.label + (hasArticle ? ' (double-click to open)' : ''),
          shape: 'dot',
          size: node.label === companyName ? 30 : 20,
          hasArticle: hasArticle,
          url: node.url,
          font: {
            color: hasArticle ? '#fbbf24' : '#e2e8f0',  // Gold for clickable
            size: 14,
            face: 'system-ui',
            bold: hasArticle ? { size: 15 } : undefined
          },
          borderWidth: hasArticle ? 3 : 2,  // Thicker border for clickable
          borderWidthSelected: hasArticle ? 5 : 4
        };
      }));

      const edges = new vis.DataSet(graphData.edges.map(edge => ({
        from: edge.from,
        to: edge.to,
        label: edge.label || '',
        title: edge.title || '',
        arrows: 'to',
        font: {
          color: '#94a3b8',
          size: 10,
          align: 'middle'
        },
        color: {
          color: '#475569',
          highlight: '#3b82f6'
        }
      })));

      const data = { nodes, edges };

      const options = {
        nodes: {
          borderWidth: 2,
          borderWidthSelected: 4,
          color: {
            border: '#334155',
            background: '#1e293b',
            highlight: {
              border: '#3b82f6',
              background: '#1e3a8a'
            }
          }
        },
        edges: {
          width: 2,
          smooth: {
            type: 'continuous'
          }
        },
        physics: {
          stabilization: {
            iterations: 200
          },
          barnesHut: {
            gravitationalConstant: -2000,
            centralGravity: 0.3,
            springLength: 150,
            springConstant: 0.04
          }
        },
        interaction: {
          hover: true,
          tooltipDelay: 100,
          navigationButtons: true,
          keyboard: true
        },
        groups: {
          company: {
            color: { background: '#3b82f6', border: '#1e40af' }
          },
          deal: {
            color: { background: '#a855f7', border: '#7e22ce' }
          },
          person: {
            color: { background: '#10b981', border: '#059669' }
          },
          article: {
            color: { background: '#f59e0b', border: '#d97706' }
          }
        }
      };

      const network = new vis.Network(networkEl, data, options);

      // Add click handler to focus/zoom to nodes
      network.on('click', (params) => {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = nodes.get(nodeId);
          console.log('Clicked node:', node);

          // Focus/zoom to the clicked node
          network.focus(nodeId, {
            scale: 1.5,
            animation: {
              duration: 800,
              easingFunction: 'easeInOutQuad'
            }
          });

          // Select the node visually
          network.selectNodes([nodeId]);
        }
      });

      // Double-click to navigate (if article exists)
      network.on('doubleClick', (params) => {
        if (params.nodes.length > 0) {
          const nodeId = params.nodes[0];
          const node = nodes.get(nodeId);

          // Only navigate if node has article/URL
          if (node.hasArticle || node.url) {
            if (node.url) {
              window.location.href = node.url;
            } else if (node.group === 'company') {
              const slug = node.label.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
              window.location.href = `/private-equity-placement-agents/${slug}`;
            } else if (node.group === 'article') {
              const slug = node.label.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
              window.location.href = `/articles/${slug}`;
            }
          }
        }
      });

    } catch (error) {
      console.error('Error loading graph:', error);
      loadingEl.classList.add('hidden');
      errorEl.classList.remove('hidden');
      errorEl.classList.add('flex');
    }
  });
</script>

<style>
  #graph-network {
    border-radius: 0.75rem;
  }

  /* vis-network overrides for dark theme */
  :global(.vis-network) {
    background: transparent !important;
  }

  :global(.vis-tooltip) {
    background: #1e293b !important;
    border: 1px solid #334155 !important;
    color: #e2e8f0 !important;
    border-radius: 0.5rem !important;
    padding: 0.5rem !important;
    font-size: 0.875rem !important;
  }
</style>
