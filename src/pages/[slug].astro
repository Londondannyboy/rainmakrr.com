---
import { sql } from '../lib/db';
import { marked } from 'marked';
import { insertImagesIntoHTML } from '../lib/insertImages';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Configure marked for better formatting
marked.setOptions({
  breaks: false,  // Don't convert single \n to <br> (proper paragraph spacing)
  gfm: true,      // GitHub Flavored Markdown
});

// Fetch the article with images and video - using Quest schema (video-first)
const articleResult = await sql`
  SELECT
    id,
    title,
    content,
    excerpt,
    slug,
    published_at,
    created_at,
    article_angle,
    hero_asset_url,
    hero_asset_alt,
    video_url,
    video_playback_id,
    content_image_1_url,
    content_image_1_alt,
    content_image_2_url,
    content_image_2_alt,
    content_image_3_url,
    content_image_3_alt
  FROM articles
  WHERE slug = ${slug}
    AND app = 'placement'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Use video_playback_id directly, or extract from video_url as fallback
function getMuxPlaybackId(playbackId: string | null, videoUrl: string | null): string | null {
  // Prefer direct playback_id if available
  if (playbackId) return playbackId;
  if (!videoUrl) return null;
  // Extract from URL if needed
  const match = videoUrl.match(/mux\.com\/([a-zA-Z0-9]+)/);
  if (match) return match[1];
  return null;
}

const muxPlaybackId = getMuxPlaybackId(article.video_playback_id, article.video_url);

// Check if content is HTML or Markdown
const isHtml = article.content && article.content.includes('<');

// Parse content - if it's HTML, use directly; if markdown, parse it
const baseHtml = isHtml ? article.content : marked(article.content);

// Intelligently insert images before H2/H3 headings using Quest schema
const html = insertImagesIntoHTML(baseHtml, null, {
  content_image_legacy: article.content_image_1_url ? { url: article.content_image_1_url, alt: article.content_image_1_alt } : null,
  content2_image_legacy: article.content_image_2_url ? { url: article.content_image_2_url, alt: article.content_image_2_alt } : null,
  content3_image_legacy: article.content_image_3_url ? { url: article.content_image_3_url, alt: article.content_image_3_alt } : null,
  content4_image_legacy: null
});

// Check if excerpt is truncated
const isTruncatedExcerpt = article.excerpt && (
  article.excerpt.trim().endsWith("'") ||
  article.excerpt.trim().endsWith('"') ||
  article.excerpt.trim().endsWith('with') ||
  article.excerpt.length < 50
);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Placement</title>
  <meta name="description" content={article.excerpt || article.title}>
  <style is:inline>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f9fafb;
      color: #111827;
      line-height: 1.6;
    }
    /* Navigation */
    .nav {
      background: #fff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .nav-inner {
      max-width: 80rem;
      margin: 0 auto;
      padding: 0 1rem;
      display: flex;
      justify-content: space-between;
      height: 4rem;
      align-items: center;
    }
    .nav-logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: #2563eb;
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 2rem;
    }
    .nav-links a {
      color: #374151;
      text-decoration: none;
      font-weight: 500;
    }
    .nav-links a:hover { color: #2563eb; }
    /* Article */
    .article { padding: 3rem 0; }
    .article-inner {
      max-width: 56rem;
      margin: 0 auto;
      padding: 0 1rem;
    }
    .article-header { margin-bottom: 2rem; }
    .article-tag {
      display: inline-block;
      background: #dbeafe;
      color: #1e40af;
      font-size: 0.75rem;
      font-weight: 600;
      padding: 0.125rem 0.625rem;
      border-radius: 0.25rem;
      margin-bottom: 1rem;
    }
    .article-title {
      font-size: 2.5rem;
      font-weight: 700;
      color: #111827;
      margin-bottom: 1rem;
      line-height: 1.2;
    }
    @media (min-width: 768px) { .article-title { font-size: 3rem; } }
    .article-excerpt {
      font-size: 1.25rem;
      color: #4b5563;
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    .article-meta {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 2rem;
    }
    .article-hero {
      margin-bottom: 2rem;
      border-radius: 0.5rem;
      overflow: hidden;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    .article-hero video,
    .article-hero img {
      width: 100%;
      height: auto;
      display: block;
    }
    .article-body {
      background: #fff;
      border-radius: 0.5rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      padding: 2rem;
    }
    @media (min-width: 768px) { .article-body { padding: 3rem; } }
    /* Prose styles */
    .prose { color: #374151; max-width: 65ch; font-size: 1.125rem; line-height: 1.7778; }
    .prose p { margin: 1.25em 0 2rem; line-height: 1.625; color: #374151; }
    .prose strong { color: #111827; font-weight: 600; }
    .prose a { color: #2563eb; font-weight: 700; text-decoration: underline; }
    .prose a:hover { color: #1e40af; }
    .prose ul, .prose ol { margin: 2rem 0; padding-left: 1.5rem; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    .prose li { margin: 0.75rem 0; color: #374151; }
    .prose h1 { color: #111827; font-weight: 700; font-size: 2.25em; margin: 0 0 0.889em; line-height: 1.111; }
    .prose h2 { color: #111827; font-weight: 700; font-size: 1.875rem; margin: 3rem 0 1.5rem; line-height: 1.333; }
    .prose h3 { color: #111827; font-weight: 700; font-size: 1.5rem; margin: 2rem 0 1rem; line-height: 1.6; }
    .prose h4 { color: #111827; font-weight: 600; margin: 1.5em 0 0.5em; line-height: 1.5; }
    .prose blockquote { color: #111827; font-style: italic; border-left: 4px solid #2563eb; padding-left: 1rem; margin: 2rem 0; }
    .prose code { color: #111827; background: #f3f4f6; padding: 0.1875em 0.375em; border-radius: 0.3125rem; font-size: 0.875em; }
    .prose pre { background: #1f2937; color: #e5e7eb; overflow-x: auto; padding: 1em; border-radius: 0.375rem; margin: 1.714em 0; }
    .prose pre code { background: transparent; padding: 0; color: #e5e7eb; }
    .prose img { margin: 2em 0; max-width: 100%; height: auto; }
    /* Related Links */
    .related {
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid #e5e7eb;
    }
    .related h3 {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      margin-bottom: 1rem;
    }
    .related-links {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .related-link {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      background: #eff6ff;
      color: #1d4ed8;
      border-radius: 0.5rem;
      font-weight: 500;
      font-size: 0.875rem;
      text-decoration: none;
    }
    .related-link:hover { background: #dbeafe; }
    .related-link-gray {
      background: #f3f4f6;
      color: #374151;
    }
    .related-link-gray:hover { background: #e5e7eb; }
    /* Footer */
    .footer {
      background: #111827;
      color: #fff;
      padding: 3rem 0;
      margin-top: 4rem;
      text-align: center;
    }
    .footer p { color: #9ca3af; }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-inner">
      <a href="/" class="nav-logo">Placement</a>
      <div class="nav-links">
        <a href="/">Home</a>
        <a href="/private-equity-placement-agent-news">News</a>
      </div>
    </div>
  </nav>

  <!-- Article Content -->
  <article class="article">
    <div class="article-inner">
      <!-- Article Header -->
      <header class="article-header">
        {article.article_angle && (
          <span class="article-tag">{article.article_angle}</span>
        )}
        <h1 class="article-title">{article.title}</h1>
        {article.excerpt && !isTruncatedExcerpt && (
          <p class="article-excerpt">{article.excerpt}</p>
        )}
        <div class="article-meta">
          <time datetime={article.published_at || article.created_at}>
            {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        </div>

        <!-- Hero Video/Image - Video supersedes image if available -->
        {muxPlaybackId ? (
          <div class="article-hero">
            <video
              autoplay
              loop
              muted
              playsinline
              poster={article.hero_asset_url || `https://image.mux.com/${muxPlaybackId}/thumbnail.jpg?time=1`}
            >
              <source src={`https://stream.mux.com/${muxPlaybackId}.m3u8`} type="application/x-mpegURL" />
              <source src={`https://stream.mux.com/${muxPlaybackId}/high.mp4`} type="video/mp4" />
            </video>
          </div>
        ) : article.hero_asset_url && (
          <div class="article-hero">
            <img
              src={article.hero_asset_url}
              alt={article.hero_asset_alt || article.title}
            />
          </div>
        )}
      </header>

      <!-- Article Body -->
      <div class="article-body">
        <div set:html={html} class="prose" />
      </div>

      <!-- Related Links -->
      <div class="related">
        <h3>Explore More</h3>
        <div class="related-links">
          <a href="/" class="related-link">Top Private Equity Placement Agents</a>
          <a href="/" class="related-link">Placement Agents</a>
          <a href="/private-equity-placement-agents-list" class="related-link">PE Placement Agent Directory</a>
          <a href="/" class="related-link">Best Placement Agents 2025</a>
          <a href="/private-equity-placement-agent-news" class="related-link related-link-gray">← More News</a>
        </div>
      </div>
    </div>
  </article>

  <!-- Footer -->
  <footer class="footer">
    <p>© {new Date().getFullYear()} Placement. All rights reserved.</p>
  </footer>
</body>
</html>
