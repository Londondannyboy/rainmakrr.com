---
import { sql } from '../lib/db';
import { marked } from 'marked';
import { insertImagesIntoHTML } from '../lib/insertImages';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// Configure marked for better formatting
marked.setOptions({
  breaks: false,  // Don't convert single \n to <br> (proper paragraph spacing)
  gfm: true,      // GitHub Flavored Markdown
});

// Fetch the article with images and video - using Quest schema (video-first)
const articleResult = await sql`
  SELECT
    id,
    title,
    content,
    excerpt,
    slug,
    published_at,
    created_at,
    article_angle,
    hero_asset_url,
    hero_asset_alt,
    video_url,
    video_playback_id,
    content_image_1_url,
    content_image_1_alt,
    content_image_2_url,
    content_image_2_alt,
    content_image_3_url,
    content_image_3_alt
  FROM articles
  WHERE slug = ${slug}
    AND app = 'placement'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Use video_playback_id directly, or extract from video_url as fallback
function getMuxPlaybackId(playbackId: string | null, videoUrl: string | null): string | null {
  // Prefer direct playback_id if available
  if (playbackId) return playbackId;
  if (!videoUrl) return null;
  // Extract from URL if needed
  const match = videoUrl.match(/mux\.com\/([a-zA-Z0-9]+)/);
  if (match) return match[1];
  return null;
}

const muxPlaybackId = getMuxPlaybackId(article.video_playback_id, article.video_url);

// Check if content is HTML or Markdown
const isHtml = article.content && article.content.includes('<');

// Parse content - if it's HTML, use directly; if markdown, parse it
const baseHtml = isHtml ? article.content : marked(article.content);

// Intelligently insert images before H2/H3 headings using Quest schema
const html = insertImagesIntoHTML(baseHtml, null, {
  content_image_legacy: article.content_image_1_url ? { url: article.content_image_1_url, alt: article.content_image_1_alt } : null,
  content2_image_legacy: article.content_image_2_url ? { url: article.content_image_2_url, alt: article.content_image_2_alt } : null,
  content3_image_legacy: article.content_image_3_url ? { url: article.content_image_3_url, alt: article.content_image_3_alt } : null,
  content4_image_legacy: null
});

// Check if excerpt is truncated
const isTruncatedExcerpt = article.excerpt && (
  article.excerpt.trim().endsWith("'") ||
  article.excerpt.trim().endsWith('"') ||
  article.excerpt.trim().endsWith('with') ||
  article.excerpt.length < 50
);
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Placement</title>
  <meta name="description" content={article.excerpt || article.title}>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center">
          <h1 class="text-2xl font-bold text-blue-600">
            <a href="/">Placement</a>
          </h1>
        </div>
        <div class="flex items-center space-x-8">
          <a href="/" class="text-gray-700 hover:text-blue-600 font-medium">Home</a>
          <a href="/private-equity-placement-agent-news" class="text-gray-700 hover:text-blue-600 font-medium">News</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Article Content -->
  <article class="py-12">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- Article Header -->
      <header class="mb-8">
        {article.article_angle && (
          <span class="inline-block bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded mb-4">
            {article.article_angle}
          </span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 leading-tight">
          {article.title}
        </h1>
        {article.excerpt && !isTruncatedExcerpt && (
          <p class="text-xl text-gray-600 mb-6 leading-relaxed">
            {article.excerpt}
          </p>
        )}
        <div class="flex items-center text-sm text-gray-500 space-x-4 mb-8">
          <time datetime={article.published_at || article.created_at}>
            {new Date(article.published_at || article.created_at).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}
          </time>
        </div>

        <!-- Hero Video/Image - Video supersedes image if available -->
        {muxPlaybackId ? (
          <div class="mb-8 relative rounded-lg overflow-hidden shadow-lg">
            <video
              autoplay
              loop
              muted
              playsinline
              class="w-full h-auto"
              poster={article.hero_asset_url || `https://image.mux.com/${muxPlaybackId}/thumbnail.jpg?time=1`}
            >
              <source src={`https://stream.mux.com/${muxPlaybackId}.m3u8`} type="application/x-mpegURL" />
              <source src={`https://stream.mux.com/${muxPlaybackId}/high.mp4`} type="video/mp4" />
            </video>
          </div>
        ) : article.hero_asset_url && (
          <div class="mb-8">
            <img
              src={article.hero_asset_url}
              alt={article.hero_asset_alt || article.title}
              class="w-full h-auto rounded-lg shadow-lg"
            />
          </div>
        )}
      </header>

      <!-- Article Body -->
      <div class="bg-white rounded-lg shadow-sm p-8 md:p-12">
        <div
          set:html={html}
          class="prose prose-lg prose-blue max-w-none
                 prose-headings:font-bold prose-headings:text-gray-900
                 prose-h2:text-3xl prose-h2:mt-12 prose-h2:mb-6
                 prose-h3:text-2xl prose-h3:mt-8 prose-h3:mb-4
                 prose-p:text-gray-700 prose-p:leading-relaxed prose-p:mb-8
                 prose-a:text-blue-600 prose-a:font-bold prose-a:underline hover:prose-a:text-blue-800
                 prose-strong:text-gray-900 prose-strong:font-semibold
                 prose-ul:my-8 prose-ul:list-disc prose-ul:pl-6
                 prose-ol:my-8 prose-ol:list-decimal prose-ol:pl-6
                 prose-li:mb-3 prose-li:text-gray-700
                 prose-blockquote:border-l-4 prose-blockquote:border-blue-600 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:my-8
                 prose-code:bg-gray-100 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-sm"
        />
      </div>

      <!-- Related Links -->
      <div class="mt-12 pt-8 border-t border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">Explore More</h3>
        <div class="flex flex-wrap gap-3">
          <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-medium text-sm">
            Top Private Equity Placement Agents
          </a>
          <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-medium text-sm">
            Placement Agents
          </a>
          <a href="/private-equity-placement-agents-list" class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-medium text-sm">
            PE Placement Agent Directory
          </a>
          <a href="/" class="inline-flex items-center px-4 py-2 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 font-medium text-sm">
            Best Placement Agents 2025
          </a>
          <a href="/private-equity-placement-agent-news" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium text-sm">
            ← More News
          </a>
        </div>
      </div>
    </div>
  </article>

  <!-- Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">© {new Date().getFullYear()} Placement. All rights reserved.</p>
    </div>
  </footer>

  <!-- Lightweight custom prose styles (replaces 91KB @tailwindcss/typography) -->
  <style>
    .prose {
      color: #374151;
      max-width: 65ch;
      font-size: 1rem;
      line-height: 1.75;
    }
    .prose-lg { font-size: 1.125rem; line-height: 1.7777778; }
    .prose-blue a { color: #2563eb; }
    .prose p { margin: 1.25em 0; line-height: 1.625; }
    .prose strong { color: #111827; font-weight: 600; }
    .prose a { color: #2563eb; font-weight: 500; text-decoration: underline; }
    .prose a:hover { color: #1e40af; }
    .prose ul, .prose ol { margin: 1.25em 0; padding-left: 1.625em; }
    .prose ul { list-style-type: disc; }
    .prose ol { list-style-type: decimal; }
    .prose li { margin: 0.75em 0; color: #374151; }
    .prose h1 { color: #111827; font-weight: 800; font-size: 2.25em; margin: 0 0 0.8888889em; line-height: 1.1111111; }
    .prose h2 { color: #111827; font-weight: 700; font-size: 1.5em; margin: 3em 0 1.5em; line-height: 1.3333333; }
    .prose h3 { color: #111827; font-weight: 600; font-size: 1.25em; margin: 2em 0 1em; line-height: 1.6; }
    .prose h4 { color: #111827; font-weight: 600; margin: 1.5em 0 0.5em; line-height: 1.5; }
    .prose blockquote { color: #111827; font-style: italic; border-left: 0.25rem solid #2563eb; padding-left: 1em; margin: 2em 0; }
    .prose code { color: #111827; background: #f3f4f6; padding: 0.1875em 0.375em; border-radius: 0.3125rem; font-size: 0.875em; }
    .prose pre { background: #1f2937; color: #e5e7eb; overflow-x: auto; padding: 1em; border-radius: 0.375rem; margin: 1.7142857em 0; }
    .prose pre code { background: transparent; padding: 0; color: #e5e7eb; }
    .prose img { margin: 2em 0; }
    .prose-headings\:font-bold h1, .prose-headings\:font-bold h2, .prose-headings\:font-bold h3, .prose-headings\:font-bold h4 { font-weight: 700; }
    .prose-headings\:text-gray-900 h1, .prose-headings\:text-gray-900 h2, .prose-headings\:text-gray-900 h3, .prose-headings\:text-gray-900 h4 { color: #111827; }
    .prose-p\:text-gray-700 p { color: #374151; }
    .prose-p\:leading-relaxed p { line-height: 1.625; }
    .prose-p\:mb-8 p { margin-bottom: 2rem; }
    .prose-strong\:text-gray-900 strong { color: #111827; }
    .prose-strong\:font-semibold strong { font-weight: 600; }
    .prose-a\:text-blue-600 a { color: #2563eb; }
    .prose-a\:font-bold a { font-weight: 700; }
    .prose-a\:underline a { text-decoration: underline; }
    .prose-li\:mb-3 li { margin-bottom: 0.75rem; }
    .prose-li\:text-gray-700 li { color: #374151; }
    .prose-blockquote\:border-l-4 blockquote { border-left-width: 4px; }
    .prose-blockquote\:border-blue-600 blockquote { border-color: #2563eb; }
    .prose-blockquote\:pl-4 blockquote { padding-left: 1rem; }
    .prose-blockquote\:italic blockquote { font-style: italic; }
    .prose-blockquote\:my-8 blockquote { margin-top: 2rem; margin-bottom: 2rem; }
    .prose-code\:bg-gray-100 code { background-color: #f3f4f6; }
    .prose-code\:px-1 code { padding-left: 0.25rem; padding-right: 0.25rem; }
    .prose-code\:py-0\.5 code { padding-top: 0.125rem; padding-bottom: 0.125rem; }
    .prose-code\:rounded code { border-radius: 0.25rem; }
    .prose-code\:text-sm code { font-size: 0.875rem; }
    .prose-h2\:text-3xl h2 { font-size: 1.875rem; }
    .prose-h2\:mt-12 h2 { margin-top: 3rem; }
    .prose-h2\:mb-6 h2 { margin-bottom: 1.5rem; }
    .prose-h3\:text-2xl h3 { font-size: 1.5rem; }
    .prose-h3\:mt-8 h3 { margin-top: 2rem; }
    .prose-h3\:mb-4 h3 { margin-bottom: 1rem; }
    .prose-ul\:my-8 ul { margin-top: 2rem; margin-bottom: 2rem; }
    .prose-ul\:list-disc ul { list-style-type: disc; }
    .prose-ul\:pl-6 ul { padding-left: 1.5rem; }
    .prose-ol\:my-8 ol { margin-top: 2rem; margin-bottom: 2rem; }
    .prose-ol\:list-decimal ol { list-style-type: decimal; }
    .prose-ol\:pl-6 ol { padding-left: 1.5rem; }
  </style>
</body>
</html>
