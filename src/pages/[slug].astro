---
/**
 * Placement Quest Article Template
 * =================================
 * Refactored to use component library for cleaner, maintainable code.
 *
 * Components: src/components/article/
 * Templates: content-worker/src/config/app_config.py (PLACEMENT_CONFIG)
 */
import { sql } from '../lib/db';

// Import article components
import HeroVideo from '../components/article/HeroVideo.astro';
import EpisodicBar from '../components/article/EpisodicBar.astro';
import ChapterNav from '../components/article/ChapterNav.astro';
import TickerTape from '../components/article/TickerTape.astro';
import ActSection from '../components/article/ActSection.astro';
import Timeline from '../components/article/Timeline.astro';
import FAQ from '../components/article/FAQ.astro';
import Callout from '../components/article/Callout.astro';
import Comparison from '../components/article/Comparison.astro';
import StatHighlight from '../components/article/StatHighlight.astro';
import Sources from '../components/article/Sources.astro';
import InvestmentDisclaimer from '../components/article/InvestmentDisclaimer.astro';
import ArticleFooter from '../components/article/ArticleFooter.astro';

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/');
}

// PRIORITY 1: Check if this is a company profile and redirect
const companyCheck = await sql`
  SELECT slug FROM companies
  WHERE slug = ${slug}
    AND company_type = 'placement_agent'
  LIMIT 1
`;

if (companyCheck.length > 0) {
  return Astro.redirect(`/private-equity-placement-agents-list/${slug}`);
}

// PRIORITY 2: Fetch article with 4-act structured data
const articleResult = await sql`
  SELECT
    a.id,
    a.title,
    a.content,
    a.meta_description as excerpt,
    a.slug,
    a.published_at,
    a.created_at,
    a.article_angle,
    a.word_count,
    a.video_url,
    a.video_playback_id,
    a.featured_asset_url,
    a.hero_asset_url,
    a.video_narrative,
    a.payload
  FROM articles a
  WHERE a.slug = ${slug}
    AND a.app = 'placement'
  LIMIT 1
`;

const article = articleResult[0];

if (!article) {
  return Astro.redirect('/');
}

// Fetch related articles
const relatedResult = await sql`
  SELECT slug, title, meta_description, video_playback_id, article_angle
  FROM articles
  WHERE app = 'placement'
    AND slug != ${slug}
    AND published_at IS NOT NULL
  ORDER BY created_at DESC
  LIMIT 3
`;
const relatedArticles = relatedResult || [];

// Parse video_narrative (4-act video data)
let videoData: any = null;
try {
  videoData = typeof article.video_narrative === 'string'
    ? JSON.parse(article.video_narrative)
    : article.video_narrative;
} catch (e) {
  console.error('Failed to parse video_narrative:', e);
}

// Parse payload for structured content
let fourActContent: any[] = [];
let faq: any[] = [];
let callouts: any[] = [];
let statHighlight: any = null;
let comparison: any = null;
let timeline: any[] = [];
let sources: any[] = [];
let articleTemplate: string = 'deal_story';

try {
  const payload = typeof article.payload === 'string'
    ? JSON.parse(article.payload)
    : article.payload;
  if (payload) {
    fourActContent = payload.four_act_content || payload.sections || [];
    faq = payload.faq || [];
    callouts = payload.callouts || [];
    statHighlight = payload.stat_highlight || null;
    comparison = payload.comparison || null;
    timeline = payload.timeline || [];
    sources = payload.structured_sources || payload.sources || [];
    articleTemplate = payload.template || 'deal_story';
    if (!videoData && payload.video_narrative) {
      videoData = payload.video_narrative;
    }
  }
} catch (e) {
  console.error('Failed to parse payload:', e);
}

// Get playback ID
const playbackId = videoData?.playback_id || article.video_playback_id;

// Check if this is an investment guide (requires disclaimer)
const requiresDisclaimer = articleTemplate === 'investment_guide';

// Split content by H2 headers to match with fourActContent sections
function splitContentBySections(html: string): string[] {
  if (!html) return [];
  const sections = html.split(/<h2[^>]*>/i);
  return sections.map((s, i) => {
    if (i === 0) return s;
    return '<h2>' + s;
  }).filter(s => s.trim());
}

const contentSections = splitContentBySections(article.content || '');

// Clean up excerpt
let excerpt = article.excerpt || '';
if (excerpt && !excerpt.endsWith('.') && !excerpt.endsWith('!') && !excerpt.endsWith('?')) {
  const lastSentence = Math.max(excerpt.lastIndexOf('.'), excerpt.lastIndexOf('?'), excerpt.lastIndexOf('!'));
  if (lastSentence > excerpt.length * 0.5) {
    excerpt = excerpt.substring(0, lastSentence + 1);
  } else {
    excerpt = excerpt.trim() + '...';
  }
}

// Act timestamps for video
const actTimestamps = [
  { start: 0, end: 3, mid: 1.5 },
  { start: 3, end: 6, mid: 4.5 },
  { start: 6, end: 9, mid: 7.5 },
  { start: 9, end: 12, mid: 10.5 }
];
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{article.title} - Placement Quest</title>
  <meta name="description" content={excerpt || article.title}>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://unpkg.com/@mux/mux-player"></script>
  <style is:global>
    /* Finance-themed prose styling */
    .prose h2 {
      font-size: 1.5rem;
      font-weight: 700;
      color: #111827;
      margin-top: 2rem;
      margin-bottom: 1rem;
    }
    .prose p {
      color: #374151;
      line-height: 1.85;
      margin-bottom: 1.5rem;
    }
    .prose strong, .prose b {
      color: #1e40af;
      font-weight: 700;
      background: linear-gradient(120deg, #dbeafe 0%, #bfdbfe 100%);
      padding: 0 0.25rem;
      border-radius: 0.125rem;
    }
    .prose a {
      color: #2563eb;
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 500;
    }
    .prose a:hover {
      color: #1d4ed8;
    }
    .prose ul {
      list-style: none;
      padding-left: 0;
      display: grid;
      gap: 0.75rem;
      margin: 1.5rem 0;
    }
    .prose ul li {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border: 1px solid #e2e8f0;
      border-left: 3px solid #2563eb;
      padding: 1rem 1.25rem;
      border-radius: 0 0.5rem 0.5rem 0;
      margin-bottom: 0;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }
    .prose ul li::before {
      content: '→';
      color: #2563eb;
      font-weight: bold;
      flex-shrink: 0;
    }
    .prose ol {
      margin-bottom: 1.75rem;
      padding-left: 1.5rem;
    }
    .prose li {
      margin-bottom: 0.75rem;
      color: #374151;
      line-height: 1.7;
    }
    .prose blockquote {
      border-left: 4px solid #2563eb;
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #fff 100%);
      padding: 1.5rem 2rem;
      margin: 2rem 0;
      font-style: italic;
      color: #1f2937;
      border-radius: 0 1rem 1rem 0;
    }
  </style>
</head>
<body class="bg-white">
  <!-- Navigation -->
  <nav class="bg-white border-b border-gray-100 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <a href="/" class="text-2xl font-bold text-blue-600">Placement</a>
      <div class="flex items-center gap-6">
        <a href="/" class="text-gray-600 hover:text-blue-600 font-medium">Home</a>
        <a href="/private-equity-placement-agent-news" class="text-gray-600 hover:text-blue-600 font-medium">News</a>
        <a href="/private-equity-placement-agents-list" class="text-gray-600 hover:text-blue-600 font-medium">Directory</a>
      </div>
    </div>
  </nav>

  <!-- Hero Section -->
  {playbackId ? (
    <HeroVideo
      playbackId={playbackId}
      title={article.title}
      excerpt={excerpt}
      articleAngle={article.article_angle}
    />
  ) : (
    <header class="bg-gradient-to-br from-blue-50 to-indigo-50 py-16">
      <div class="max-w-4xl mx-auto px-4">
        {article.article_angle && (
          <span class="text-blue-600 text-sm font-semibold uppercase tracking-wider">{article.article_angle}</span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mt-2 mb-4">{article.title}</h1>
        {excerpt && <p class="text-xl text-gray-600">{excerpt}</p>}
      </div>
    </header>
  )}

  <!-- Episodic Bar & Chapter Nav -->
  {playbackId && fourActContent.length >= 4 && (
    <>
      <EpisodicBar />
      <ChapterNav acts={fourActContent} />
    </>
  )}

  <main class="max-w-4xl mx-auto px-4 py-12">
    <!-- Investment Disclaimer (prominent, if required) -->
    {requiresDisclaimer && (
      <InvestmentDisclaimer variant="prominent" />
    )}

    <!-- Preamble (content before first H2) -->
    {contentSections[0] && !contentSections[0].startsWith('<h2') && (
      <div class="prose prose-lg max-w-none mb-8">
        <div set:html={contentSections[0]} />
      </div>
    )}

    <!-- Hook Statement -->
    {fourActContent[0]?.factoid && (
      <div class="text-2xl font-bold text-gray-900 border-l-4 border-blue-500 pl-6 my-8">
        <span class="bg-gradient-to-r from-blue-100 to-indigo-100 px-2 py-1 rounded">
          {fourActContent[0].factoid}
        </span>
      </div>
    )}

    <!-- 4-Act Ticker Tape -->
    {playbackId && fourActContent.length >= 4 && (
      <TickerTape acts={fourActContent} playbackId={playbackId} />
    )}

    <!-- Video Progress Divider -->
    {playbackId && (
      <div class="my-12 flex items-center justify-center gap-3 text-xs text-gray-400 font-mono">
        <span class="w-8 h-px bg-gradient-to-r from-transparent to-gray-300"></span>
        <span class="text-blue-500">0s</span>
        <span class="w-12 h-px bg-blue-300/50"></span>
        <span class="text-indigo-500">3s</span>
        <span class="w-12 h-px bg-indigo-300/50"></span>
        <span class="text-emerald-500">6s</span>
        <span class="w-12 h-px bg-emerald-300/50"></span>
        <span class="text-teal-500">9s</span>
        <span class="w-12 h-px bg-teal-300/50"></span>
        <span class="text-teal-600">12s</span>
        <span class="w-8 h-px bg-gradient-to-l from-transparent to-gray-300"></span>
      </div>
    )}

    <!-- 4-Act Sections -->
    {fourActContent.slice(0, 4).map((act, i) => {
      const sectionContent = contentSections.find(c => c.includes(act.title)) || '';
      const calloutForSection = callouts.find(c => c.placement === `after_section_${i + 1}`);
      const showTimeline = i === 0 && timeline.length > 0;
      const showRelated = i === 1 && relatedArticles.length > 0;

      return (
        <>
          <ActSection
            act={act}
            actIndex={i}
            playbackId={playbackId}
            content={sectionContent}
          />

          {/* Callout after section */}
          {calloutForSection && (
            <Callout
              type={calloutForSection.type === 'warning' ? 'warning' : 'pro_tip'}
              title={calloutForSection.title}
              content={calloutForSection.content}
              imageUrl={playbackId ? `https://image.mux.com/${playbackId}/thumbnail.jpg?time=${actTimestamps[i].mid}&width=600` : undefined}
            />
          )}

          {/* Timeline after section 1 */}
          {showTimeline && (
            <Timeline events={timeline} />
          )}

          {/* Related Articles after section 2 */}
          {showRelated && (
            <div class="my-12 py-8 border-t border-b border-gray-100">
              <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Related Analysis</h3>
              <div class="grid md:grid-cols-3 gap-4">
                {relatedArticles.map((related, ri) => {
                  const relatedThumb = related.video_playback_id
                    ? `https://image.mux.com/${related.video_playback_id}/thumbnail.jpg?time=${actTimestamps[ri % 4].mid}&width=400`
                    : null;
                  return (
                    <a href={`/${related.slug}`} class="group block bg-gray-50 rounded-lg overflow-hidden hover:bg-gray-100 transition border border-gray-100">
                      {relatedThumb && (
                        <img src={relatedThumb} alt="" class="w-full h-24 object-cover opacity-80 group-hover:opacity-100 transition" loading="lazy" />
                      )}
                      <div class="p-3">
                        <p class="font-medium text-gray-900 text-sm line-clamp-2 group-hover:text-blue-600 transition">{related.title}</p>
                      </div>
                    </a>
                  );
                })}
              </div>
            </div>
          )}
        </>
      );
    })}

    <!-- Comparison Section -->
    {comparison && comparison.items && comparison.items.length > 0 && (
      <Comparison
        title={comparison.title}
        items={comparison.items}
        playbackId={playbackId}
      />
    )}

    <!-- Stat Highlight -->
    {statHighlight && (
      <StatHighlight
        headline={statHighlight.headline}
        stats={statHighlight.stats}
        playbackId={playbackId}
      />
    )}

    <!-- FAQ Section -->
    {faq && faq.length > 0 && (
      <FAQ items={faq} playbackId={playbackId} />
    )}

    <!-- Sources Section -->
    {sources && sources.length > 0 && (
      <Sources sources={sources} playbackId={playbackId} />
    )}

    <!-- Investment Disclaimer (footer, if required) -->
    {requiresDisclaimer && (
      <InvestmentDisclaimer variant="footer" />
    )}

    <!-- Article Footer -->
    <ArticleFooter
      publishedAt={article.published_at || article.created_at}
      wordCount={article.word_count}
      playbackId={playbackId}
    />
  </main>

  <!-- Site Footer -->
  <footer class="bg-gray-900 text-white py-12 mt-16">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-gray-400">&copy; {new Date().getFullYear()} Placement Quest. All rights reserved.</p>
    </div>
  </footer>

  <!-- Auto-Bold Key Financial Facts -->
  <script>
    document.querySelectorAll('.prose p, .prose li').forEach(el => {
      let html = el.innerHTML;
      const patterns = [
        /(?<![<>])([€$£]\d{1,3}(?:,\d{3})*(?:\.\d{2})?(?:\s*(?:per|\/)\s*(?:hour|month|year|annually))?)/g,
        /(?<![<>])(\d{1,3}%\s*(?:approval|tax|rate|interest|discount|increase|decrease|shortfall|returns?)?)/gi,
        /(?<![<>])(\d{1,2}(?:-\d{1,2})?\s*(?:years?|months?|weeks?|days?)\s*(?:max(?:imum)?|min(?:imum)?|total|consecutive)?)/gi,
        /(?<![<>])(\d{1,3}(?:,\d{3})*\+?\s*(?:firms?|companies|lawyers?|partners?|permits?|deals?|transactions?))/gi,
        /(?<![<>])((?:in|since|by)\s*20\d{2})/gi,
      ];
      patterns.forEach(pattern => {
        html = html.replace(pattern, (match) => {
          if (match.includes('<') || match.includes('>')) return match;
          return `<strong>${match}</strong>`;
        });
      });
      if (html !== el.innerHTML) el.innerHTML = html;
    });
  </script>

  <!-- HLS Video Init -->
  <script is:inline>
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Hls === 'undefined' || !Hls.isSupported()) return;

      const videos = document.querySelectorAll('[data-hls]');
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      videos.forEach(function(video) {
        const hlsUrl = video.dataset.hls;
        const start = parseFloat(video.dataset.start) || 0;
        const end = parseFloat(video.dataset.end) || 3;

        if (!hlsUrl) return;

        const hls = new Hls();
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, function() {
          video.currentTime = start;
        });

        video.addEventListener('timeupdate', function() {
          if (video.currentTime >= end) video.currentTime = start;
        });

        if (!prefersReducedMotion) {
          const observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting && entry.intersectionRatio >= 0.3) {
                video.play().catch(function() {});
              } else {
                video.pause();
              }
            });
          }, { threshold: 0.3 });
          observer.observe(video);
        }
      });
    });

    function seekTo(time) {
      const player = document.querySelector('mux-player');
      if (player) player.currentTime = time;
    }
  </script>
</body>
</html>
