---
import { sql } from '../../lib/db';
import SEO from '../../components/SEO.astro';
import Schema from '../../components/Schema.astro';

const { slug } = Astro.params;

if (!slug) {
  console.error('[PLACEMENT] No slug provided');
  return Astro.redirect('/');
}

console.log('[PLACEMENT] Looking for company with slug:', slug);

// Fetch company with payload
const companies = await sql`
  SELECT
    id,
    name,
    slug,
    logo_url,
    featured_image_url,
    payload
  FROM companies
  WHERE slug = ${slug}
    AND company_type = 'placement_agent'
  LIMIT 1
`;

console.log('[PLACEMENT] Query returned:', companies?.length || 0, 'companies');

const companyRow = companies[0];

if (!companyRow) {
  console.error('[PLACEMENT] No company found for slug:', slug);
  return Astro.redirect('/');
}

console.log('[PLACEMENT] Company found:', companyRow.name);

// Parse payload
const payload = companyRow.payload || {};
console.log('[PLACEMENT] Payload has profile_sections:', !!payload.profile_sections);

// Build company object
const company = {
  id: companyRow.id,
  name: companyRow.name,
  slug: companyRow.slug,
  logo_url: companyRow.logo_url || payload.logo_url,
  featured_image_url: companyRow.featured_image_url || payload.featured_image_url,
  website: payload.website,
  industry: payload.industry,
  headquarters_city: payload.headquarters_city,
  headquarters_country: payload.headquarters_country,
  founded_year: payload.founded_year,
  employee_range: payload.employee_range,
  profile_sections: payload.profile_sections || {},
};

// Get overview for description
const overviewSection = company.profile_sections.overview;
const description = overviewSection?.content?.substring(0, 200) || `${company.name} - Leading placement agent`;
const metaDescription = overviewSection?.content?.substring(0, 160) || description;

console.log('[PLACEMENT] Profile sections count:', Object.keys(company.profile_sections).length);
---

<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <SEO
    title={`${company.name} - Placement Agent Profile | Placement`}
    description={metaDescription}
  />
  <Schema type="company" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body class="bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-100 min-h-screen">
  <!-- Navigation -->
  <nav class="fixed top-0 left-0 right-0 z-50 bg-slate-900/80 backdrop-blur-xl border-b border-slate-800/50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <a href="/" class="text-xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
          Placement
        </a>
        <div class="flex items-center space-x-8">
          <a href="/articles" class="text-slate-300 hover:text-white transition-colors text-sm font-medium">Articles</a>
          <a href="/private-equity-placement-agents" class="text-blue-400 text-sm font-medium">Placement Agents</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Hero Section with Featured Image -->
  <div class="relative pt-24 pb-16 overflow-hidden">
    {company.featured_image_url && (
      <div class="absolute inset-0 z-0">
        <img
          src={company.featured_image_url}
          alt={company.name}
          class="w-full h-full object-cover opacity-10 blur-sm"
        />
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950/50 via-slate-900/80 to-slate-950"></div>
      </div>
    )}

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex flex-col lg:flex-row items-start gap-8">
        <!-- Company Info -->
        <div class="flex-1">
          {company.logo_url && (
            <img
              src={company.logo_url}
              alt={`${company.name} logo`}
              class="h-16 w-auto mb-6 rounded-lg"
            />
          )}

          <span class="inline-block px-3 py-1 bg-blue-500/20 text-blue-300 text-xs font-semibold rounded-full mb-4">
            Placement Agent
          </span>

          <h1 class="text-4xl lg:text-6xl font-black mb-4 bg-gradient-to-r from-white via-blue-100 to-purple-200 bg-clip-text text-transparent leading-tight">
            {company.name}
          </h1>

          {overviewSection && (
            <p class="text-xl text-slate-300 leading-relaxed mb-6 max-w-3xl">
              {description}...
            </p>
          )}

          <!-- Meta Info -->
          <div class="flex flex-wrap gap-6 text-sm">
            {company.founded_year && (
              <div class="flex items-center gap-2">
                <span class="text-slate-500">Founded</span>
                <span class="font-semibold text-white">{company.founded_year}</span>
              </div>
            )}
            {company.employee_range && (
              <div class="flex items-center gap-2">
                <span class="text-slate-500">Employees</span>
                <span class="font-semibold text-white">{company.employee_range}</span>
              </div>
            )}
            {company.headquarters_city && (
              <div class="flex items-center gap-2">
                <span class="text-slate-500">Location</span>
                <span class="font-semibold text-white">{company.headquarters_city}, {company.headquarters_country}</span>
              </div>
            )}
            {company.website && (
              <a href={company.website} target="_blank" rel="noopener noreferrer"
                 class="flex items-center gap-2 text-blue-400 hover:text-blue-300 transition-colors">
                <span>Visit Website</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Sections -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-20">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content (2/3) -->
      <div class="lg:col-span-2 space-y-6">
        {Object.entries(company.profile_sections)
          .filter(([key]) => key !== 'resources')
          .map(([key, section]: [string, any]) => {
            // Special handling for deals section - display as timeline cards
            if (key === 'deals' || key === 'transactions' || key === 'announcements') {
              // Parse deals from content (each line starting with -)
              const dealLines = section.content
                .split('\n')
                .filter(line => line.trim().startsWith('-'))
                .map(line => line.trim().substring(1).trim());

              return (
                <div id={key} class="group bg-gradient-to-br from-slate-900/50 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 border border-slate-700/50">
                  <div class="flex items-start gap-4 mb-8">
                    <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-emerald-500 flex items-center justify-center text-white font-bold text-lg">
                      {section.title.charAt(0)}
                    </div>
                    <div class="flex-1">
                      <h2 class="text-2xl font-bold text-white mb-1">{section.title}</h2>
                      <div class="h-1 w-20 bg-gradient-to-r from-green-500 to-emerald-500 rounded-full"></div>
                    </div>
                  </div>

                  {/* Timeline of deals */}
                  <div class="relative pl-8 space-y-6">
                    {/* Vertical timeline line */}
                    <div class="absolute left-2 top-0 bottom-0 w-px bg-gradient-to-b from-green-500 via-emerald-500 to-transparent"></div>

                    {dealLines.map((deal, index) => {
                      // Extract year/date from deal (look for patterns like "2025", "Q1 2024", "November 2024")
                      const dateMatch = deal.match(/(Q[1-4]\s+\d{4}|\w+\s+\d{4}|\d{4})/);
                      const date = dateMatch ? dateMatch[0] : 'Recent';

                      // Extract value if present (look for patterns like "$29.1B", "$500M")
                      const valueMatch = deal.match(/\$[\d.]+\s*[BM](?:illion)?/i);
                      const value = valueMatch ? valueMatch[0] : null;

                      return (
                        <div class="relative">
                          {/* Timeline dot */}
                          <div class="absolute -left-7 top-2 w-4 h-4 rounded-full bg-gradient-to-br from-green-400 to-emerald-400 border-2 border-slate-900 shadow-lg shadow-green-500/50"></div>

                          {/* Deal card */}
                          <div class="bg-gradient-to-br from-slate-800/40 to-slate-900/40 rounded-xl p-5 border border-slate-700/30 hover:border-green-500/30 transition-all duration-300 hover:shadow-lg hover:shadow-green-500/10">
                            {/* Date badge */}
                            <div class="flex items-start justify-between gap-4 mb-3">
                              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-300 border border-green-500/30">
                                <svg class="w-3 h-3 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                {date}
                              </span>
                              {value && (
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold bg-blue-500/20 text-blue-300 border border-blue-500/30">
                                  {value}
                                </span>
                              )}
                            </div>

                            {/* Deal description */}
                            <div class="text-slate-200 leading-relaxed prose prose-invert prose-sm max-w-none prose-a:text-green-400 prose-a:no-underline prose-a:font-medium hover:prose-a:text-green-300 prose-a:transition-colors">
                              <div set:html={
                                deal
                                  .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1 →</a>')
                                  .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                              }></div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            }

            // Regular section display for non-deals sections
            return (
              <div id={key} class="group bg-gradient-to-br from-slate-900/50 to-slate-800/30 backdrop-blur-sm rounded-2xl p-8 border border-slate-700/50 hover:border-blue-500/30 transition-all duration-300 hover:shadow-xl hover:shadow-blue-500/10">
                <div class="flex items-start gap-4 mb-6">
                  <div class="flex-shrink-0 w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-500 flex items-center justify-center text-white font-bold text-lg">
                    {section.title.charAt(0)}
                  </div>
                  <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white mb-1">{section.title}</h2>
                    <div class="h-1 w-20 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></div>
                  </div>
                </div>

                <div class="prose prose-invert prose-lg max-w-none
                            prose-p:text-slate-300 prose-p:leading-relaxed prose-p:mb-6
                            prose-strong:text-white prose-strong:font-semibold
                            prose-a:text-blue-400 prose-a:no-underline prose-a:border-b prose-a:border-blue-400/30 hover:prose-a:border-blue-400 prose-a:transition-colors
                            prose-ul:space-y-3 prose-li:text-slate-300
                            prose-headings:text-white">
                  <div set:html={
                    section.content
                      .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                      .replace(/([.!?])(\s+)(?!(?:Mr|Mrs|Ms|Dr|Prof|Sr|Jr|Inc|Ltd|Corp|Co|U\.S|U\.K|U\.N|E\.U|vs)\b)([A-Z])/g, '$1</p><p>$3')
                      .replace(/\n\n/g, '</p><p>')
                      .replace(/^(.+)$/m, '<p>$1</p>')
                      .replace(/^- (.+)/gm, '<li>$1</li>')
                      .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                  }></div>
                </div>
              </div>
            );
          })}
      </div>

      <!-- Sidebar (1/3) -->
      <div class="space-y-6">
        <!-- Quick Info Card -->
        {(company.industry || company.founded_year || company.employee_range || company.headquarters_city) && (
          <div class="bg-gradient-to-br from-slate-900/80 to-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50 sticky top-24">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-blue-500"></div>
              Company Info
            </h3>
            <div class="space-y-4">
              {company.industry && (
                <div>
                  <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Industry</div>
                  <div class="text-white font-medium">{company.industry}</div>
                </div>
              )}
              {company.founded_year && (
                <div>
                  <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Founded</div>
                  <div class="text-white font-medium">{company.founded_year}</div>
                </div>
              )}
              {company.employee_range && (
                <div>
                  <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Team Size</div>
                  <div class="text-white font-medium">{company.employee_range}</div>
                </div>
              )}
              {company.headquarters_city && (
                <div>
                  <div class="text-xs text-slate-500 uppercase tracking-wide mb-1">Headquarters</div>
                  <div class="text-white font-medium">{company.headquarters_city}, {company.headquarters_country}</div>
                </div>
              )}
            </div>
          </div>
        )}

        <!-- Team Highlights Card -->
        {(company.profile_sections.team || company.profile_sections.leadership) && (
          <div class="bg-gradient-to-br from-slate-900/80 to-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-purple-500"></div>
              Leadership
            </h3>
            <div class="text-sm text-slate-300 leading-relaxed prose prose-invert prose-sm max-w-none">
              <div set:html={
                ((company.profile_sections.team || company.profile_sections.leadership).content)
                  .split(/\n\n/)[0]
                  .substring(0, 300) + '...'
              }></div>
            </div>
            <a href="#team" class="inline-block mt-4 text-xs text-blue-400 hover:text-blue-300 transition-colors">
              View full team →
            </a>
          </div>
        )}

        <!-- Key Deals Card -->
        {company.profile_sections.deals && (
          <div class="bg-gradient-to-br from-slate-900/80 to-slate-800/50 backdrop-blur-sm rounded-2xl p-6 border border-slate-700/50">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
              <div class="w-2 h-2 rounded-full bg-green-500"></div>
              Recent Deals
            </h3>
            <div class="text-sm text-slate-300 leading-relaxed prose prose-invert prose-sm max-w-none prose-a:text-blue-400 prose-a:no-underline hover:prose-a:text-blue-300">
              <div set:html={
                company.profile_sections.deals.content
                  .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                  .split(/\n\n/)[0]
                  .substring(0, 300) + '...'
              }></div>
            </div>
            <a href="#deals" class="inline-block mt-4 text-xs text-blue-400 hover:text-blue-300 transition-colors">
              View all deals →
            </a>
          </div>
        )}
      </div>
    </div>

    <!-- Resources Section - Full Width at Bottom -->
    {company.profile_sections.resources && (
      <div class="mt-12 bg-gradient-to-br from-slate-900/30 to-slate-800/20 backdrop-blur-sm rounded-2xl p-8 border border-slate-700/30">
        <h2 class="text-xl font-bold text-slate-300 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {company.profile_sections.resources.title}
        </h2>
        <div class="prose prose-invert prose-sm max-w-none prose-a:text-blue-400 prose-a:no-underline hover:prose-a:text-blue-300 prose-li:text-slate-400">
          <div set:html={
            company.profile_sections.resources.content
              .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
              .replace(/^- (.+)/gm, '<li>$1</li>')
              .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
          }></div>
        </div>
      </div>
    )}

    <!-- Navigation -->
    <div class="mt-12 flex justify-between items-center">
      <a href="/private-equity-placement-agents"
         class="inline-flex items-center gap-2 px-6 py-3 bg-slate-800/50 hover:bg-slate-700/50 text-white rounded-xl transition-all duration-300 border border-slate-700/50 hover:border-blue-500/30">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        All Placement Agents
      </a>
    </div>
  </div>

  <!-- Footer -->
  <footer class="border-t border-slate-800/50 bg-slate-950/50 backdrop-blur-sm py-12">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <p class="text-slate-500 text-sm">© 2025 Placement. All rights reserved.</p>
    </div>
  </footer>
</body>
</html>
