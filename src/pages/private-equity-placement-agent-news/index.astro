---
import { sql } from '../../lib/db';
import SEO from '../../components/SEO.astro';
import Schema from '../../components/Schema.astro';
import OptimizedFonts from '../../components/OptimizedFonts.astro';
import Navigation from '../../components/Navigation.astro';
import { getVisitorCountry, getCountryName, getRegionForCountry } from '../../lib/geo';

// Detect visitor's country for geo-targeting
const visitorCountry = getVisitorCountry(Astro.request);
const visitorCountryName = getCountryName(visitorCountry);
const visitorRegion = getRegionForCountry(visitorCountry);

// Fetch featured articles (2 max)
const featuredArticles = await sql`
  SELECT
    id, title, excerpt, slug, published_at, created_at,
    article_angle, featured_asset_url, featured_asset_alt,
    video_playback_id, country, view_count
  FROM articles
  WHERE app = 'placement'
    AND status = 'published'
    AND is_featured = true
  ORDER BY published_at DESC NULLS LAST
  LIMIT 2
`;

// Fetch popular articles (top 5 by view count, excluding featured)
const featuredIds = featuredArticles.map((a: any) => a.id);
const popularArticles = await sql`
  SELECT
    id, title, excerpt, slug, published_at, created_at,
    article_angle, featured_asset_url, featured_asset_alt,
    video_playback_id, country, view_count
  FROM articles
  WHERE app = 'placement'
    AND status = 'published'
    AND is_featured = false
    AND view_count > 0
  ORDER BY view_count DESC
  LIMIT 5
`;

// Fetch all other published articles (excluding featured)
const articlesRaw = await sql`
  SELECT
    id, title, excerpt, slug, published_at, created_at,
    article_angle, featured_asset_url, featured_asset_alt,
    video_playback_id, country, view_count
  FROM articles
  WHERE app = 'placement'
    AND status = 'published'
    AND is_featured = false
  ORDER BY published_at DESC NULLS LAST, created_at DESC
`;

// Filter out articles with incomplete/truncated excerpts
const validArticles = articlesRaw.filter((article: any) => {
  if (!article.excerpt) return false;
  const trimmed = article.excerpt.trim();
  if (trimmed.endsWith("'") || trimmed.endsWith('"') || trimmed.endsWith('with') || trimmed.length < 50) {
    return false;
  }
  return true;
});

// Sort articles by geo-targeting: visitor's country first
const articles = [...validArticles].sort((a: any, b: any) => {
  if (!visitorCountryName) return 0;
  const aMatch = a.country === visitorCountryName ? 1 : 0;
  const bMatch = b.country === visitorCountryName ? 1 : 0;
  return bMatch - aMatch;
});

// Helper: format date
function formatDate(date: string | Date | null): string {
  if (!date) return '';
  return new Date(date).toLocaleDateString('en-US', {
    month: 'short', day: 'numeric', year: 'numeric'
  });
}

// Helper: get thumbnail URL
function getThumbnail(article: any): string {
  if (article.video_playback_id) {
    return `https://image.mux.com/${article.video_playback_id}/thumbnail.webp?time=1&width=600&quality=70`;
  }
  return article.featured_asset_url || '/placeholder-news.jpg';
}
---

<!DOCTYPE html>
<html lang="en">
<head>
  <SEO
    title="News - Placement Quest"
    description="Expert insights on private equity placement agents, PE fundraising, and capital raising strategies"
  />
  <Schema type="article_list" />
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Optimized Font Loading (astro-font) -->
  <OptimizedFonts />

  <!-- GSAP Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>

  <!-- Mux Video -->
  <link rel="preconnect" href="https://stream.mux.com" crossorigin>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #000;
      color: #fff;
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* Hero Section */
    .hero {
      min-height: 70vh;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 160px 40px 100px;
      position: relative;
      overflow: hidden;
      background: #000;
    }

    .hero-video {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      min-width: 100%;
      min-height: 100%;
      width: auto;
      height: auto;
      object-fit: cover;
      z-index: 1;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 2;
      pointer-events: none;
    }

    .hero-content {
      max-width: 1000px;
      position: relative;
      z-index: 10;
      opacity: 0;
    }

    .hero-badge {
      display: inline-flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(20px);
      padding: 12px 28px;
      border-radius: 100px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      margin-bottom: 40px;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .hero h1 {
      font-size: clamp(48px, 8vw, 90px);
      font-weight: 900;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #fff, #f093fb);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.1;
      letter-spacing: -0.02em;
    }

    .hero-subtitle {
      font-size: clamp(18px, 2.5vw, 24px);
      color: rgba(255, 255, 255, 0.7);
      line-height: 1.6;
      margin-bottom: 40px;
    }

    /* Articles Section */
    .articles-section {
      padding: 120px 60px;
      max-width: 1400px;
      margin: 0 auto;
      position: relative;
      z-index: 10;
    }

    .articles-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 40px;
      margin-top: 60px;
    }

    .article-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      opacity: 1;
    }

    .article-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-8px);
    }

    .article-image {
      width: 100%;
      height: 240px;
      object-fit: cover;
    }

    .article-content {
      padding: 32px;
    }

    .article-angle {
      display: inline-block;
      background: rgba(102, 126, 234, 0.2);
      color: #667eea;
      padding: 6px 16px;
      border-radius: 100px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 16px;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .article-title {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 12px;
      background: linear-gradient(135deg, #fff, #f093fb);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      line-height: 1.3;
    }

    .article-title a {
      text-decoration: none;
      transition: opacity 0.3s;
    }

    .article-title a:hover {
      opacity: 0.7;
    }

    .article-excerpt {
      color: rgba(255, 255, 255, 0.8);
      line-height: 1.7;
      margin-bottom: 20px;
      font-size: 15px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .article-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
    }

    .article-date {
      font-weight: 500;
    }

    .read-more {
      color: #667eea;
      font-weight: 600;
      text-decoration: none;
      transition: color 0.3s;
    }

    .read-more:hover {
      color: #f093fb;
    }

    .empty-state {
      text-align: center;
      padding: 100px 40px;
      opacity: 1;
    }

    .empty-state h3 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 16px;
      color: rgba(255, 255, 255, 0.9);
    }

    .empty-state p {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.6);
    }

    /* Footer */
    footer {
      padding: 80px 60px 40px;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.95) 0%, #000 100%);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }

    footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 200px;
      background: linear-gradient(180deg, rgba(102, 126, 234, 0.05), transparent);
      pointer-events: none;
    }

    .footer-content {
      max-width: 1400px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 60px;
      margin-bottom: 60px;
    }

    .footer-section h3 {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
    }

    .footer-links {
      list-style: none;
    }

    .footer-links a {
      color: rgba(255, 255, 255, 0.6);
      text-decoration: none;
      display: block;
      margin-bottom: 12px;
      transition: color 0.3s;
    }

    .footer-links a:hover {
      color: #fff;
    }

    .footer-bottom {
      text-align: center;
      padding-top: 40px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      color: rgba(255, 255, 255, 0.5);
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      .articles-section > div {
        grid-template-columns: 1fr !important;
      }

      aside {
        position: static !important;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
    }

    @media (max-width: 768px) {
      .hero {
        padding: 120px 20px 40px !important;
        min-height: 30vh !important;
      }

      .featured-section {
        padding: 40px 20px !important;
      }

      .featured-section > div > div:last-child {
        grid-template-columns: 1fr !important;
      }

      .articles-section {
        padding: 40px 20px !important;
      }

      .article-card {
        grid-template-columns: 1fr !important;
        gap: 16px !important;
      }

      .article-card > a {
        height: 200px !important;
      }

      aside {
        grid-template-columns: 1fr !important;
      }

      footer {
        padding: 60px 20px 30px;
      }

      .footer-content {
        grid-template-columns: 1fr;
        gap: 40px;
      }
    }

    .featured-card:hover {
      transform: translateY(-4px);
      border-color: rgba(102, 126, 234, 0.4);
    }

    .article-card h3 a:hover {
      color: #667eea !important;
    }
  </style>
</head>

<body>
  <!-- Navigation -->
  <Navigation />

  <!-- Compact Hero -->
  <section class="hero" style="min-height: 40vh; padding: 140px 40px 60px;">
    <div class="hero-content">
      <div class="hero-badge">Private Equity Intelligence</div>
      <h1>Placement Agent News</h1>
      <p class="hero-subtitle">
        Breaking news, deals, and analysis from the world of private equity placement agents
      </p>
      {visitorCountryName && (
        <div style="margin-top: 16px; display: inline-flex; align-items: center; gap: 8px; background: rgba(102, 126, 234, 0.2); padding: 8px 16px; border-radius: 50px; font-size: 13px;">
          <span>üìç</span> Showing {visitorCountryName} news first
        </div>
      )}
    </div>
  </section>

  <!-- Featured Articles -->
  {featuredArticles.length > 0 && (
    <section class="featured-section" style="padding: 60px 40px; background: linear-gradient(180deg, #000 0%, rgba(102, 126, 234, 0.08) 100%);">
      <div style="max-width: 1400px; margin: 0 auto;">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 32px;">
          <span style="background: linear-gradient(135deg, #667eea, #f093fb); padding: 6px 16px; border-radius: 50px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Featured</span>
          <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 32px;">
          {featuredArticles.map((article: any) => (
            <a href={`/${article.slug}`} class="featured-card" style="display: block; text-decoration: none; color: inherit; background: rgba(255, 255, 255, 0.03); border-radius: 20px; overflow: hidden; border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s;">
              <div style="position: relative; height: 280px; overflow: hidden;">
                <img src={getThumbnail(article)} alt={article.title} style="width: 100%; height: 100%; object-fit: cover;" loading="eager" />
                {article.country && (
                  <span style="position: absolute; top: 16px; left: 16px; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 50px; font-size: 11px; font-weight: 600;">{article.country}</span>
                )}
              </div>
              <div style="padding: 28px;">
                <h2 style="font-size: 22px; font-weight: 700; line-height: 1.3; margin-bottom: 12px;">{article.title}</h2>
                <p style="font-size: 15px; color: rgba(255, 255, 255, 0.7); line-height: 1.6; margin-bottom: 16px;">{article.excerpt?.slice(0, 150)}...</p>
                <div style="display: flex; align-items: center; justify-content: space-between; font-size: 13px; color: rgba(255, 255, 255, 0.5);">
                  <time>{formatDate(article.published_at)}</time>
                  <span style="color: #667eea; font-weight: 600;">Read more ‚Üí</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Main Content: Latest + Popular Sidebar -->
  <section class="articles-section" style="padding: 60px 40px;">
    <div style="max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 60px;">

      <!-- Latest News Column -->
      <div>
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 32px;">
          <span style="background: rgba(102, 126, 234, 0.15); color: #667eea; padding: 6px 16px; border-radius: 50px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Latest News</span>
          <div style="flex: 1; height: 1px; background: rgba(255, 255, 255, 0.1);"></div>
        </div>

        {articles.length > 0 ? (
          <div class="articles-grid" style="grid-template-columns: 1fr; gap: 24px;">
            {articles.map((article: any, index: number) => (
              <article class="article-card" style="display: grid; grid-template-columns: 200px 1fr; gap: 24px; padding: 0; background: transparent; border: none; border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding-bottom: 24px;">
                <a href={`/${article.slug}`} style="display: block; height: 140px; border-radius: 12px; overflow: hidden; position: relative;">
                  <img src={getThumbnail(article)} alt={article.title} style="width: 100%; height: 100%; object-fit: cover;" loading={index < 3 ? 'eager' : 'lazy'} />
                  {article.country && (
                    <span style="position: absolute; bottom: 8px; left: 8px; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                      üåç {article.country}
                    </span>
                  )}
                </a>
                <div style="display: flex; flex-direction: column; justify-content: center;">
                  <!-- Meta: Date | Country | Category -->
                  <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; flex-wrap: wrap;">
                    <time style="font-size: 12px; color: rgba(255, 255, 255, 0.5); display: flex; align-items: center; gap: 4px;">
                      <span style="opacity: 0.7;">üìÖ</span> {formatDate(article.published_at)}
                    </time>
                    {article.country && (
                      <span style="font-size: 11px; font-weight: 600; color: #667eea; text-transform: uppercase; background: rgba(102, 126, 234, 0.15); padding: 3px 8px; border-radius: 4px;">
                        {article.country}
                      </span>
                    )}
                    {article.article_angle && (
                      <span style="font-size: 11px; font-weight: 600; color: #f093fb; text-transform: uppercase; background: rgba(240, 147, 251, 0.15); padding: 3px 8px; border-radius: 4px;">
                        {article.article_angle}
                      </span>
                    )}
                  </div>
                  <h3 style="font-size: 17px; font-weight: 600; line-height: 1.4; margin-bottom: 8px;">
                    <a href={`/${article.slug}`} style="color: #fff; text-decoration: none; transition: color 0.2s;">{article.title}</a>
                  </h3>
                  <p style="font-size: 14px; color: rgba(255, 255, 255, 0.6); line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">{article.excerpt}</p>
                </div>
              </article>
            ))}
          </div>
        ) : (
          <div class="empty-state">
            <h3>Coming Soon</h3>
            <p>We're currently curating expert insights. Check back soon!</p>
          </div>
        )}
      </div>

      <!-- Sidebar: Popular Articles -->
      <aside style="position: sticky; top: 100px; height: fit-content;">
        <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 28px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 24px;">
            <span style="font-size: 18px;">üî•</span>
            <h3 style="font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">Most Read</h3>
          </div>

          {popularArticles.length > 0 ? (
            <div style="display: flex; flex-direction: column; gap: 20px;">
              {popularArticles.map((article: any, index: number) => (
                <a href={`/${article.slug}`} style="display: flex; gap: 16px; text-decoration: none; color: inherit; padding-bottom: 16px; border-bottom: 1px solid rgba(255, 255, 255, 0.05);">
                  <span style="font-size: 28px; font-weight: 900; color: rgba(102, 126, 234, 0.3); line-height: 1;">{index + 1}</span>
                  <div>
                    <h4 style="font-size: 14px; font-weight: 600; line-height: 1.4; margin-bottom: 4px; color: #fff;">{article.title}</h4>
                    <span style="font-size: 12px; color: rgba(255, 255, 255, 0.5);">{article.view_count || 0} views</span>
                  </div>
                </a>
              ))}
            </div>
          ) : (
            <p style="font-size: 14px; color: rgba(255, 255, 255, 0.5);">Popular articles coming soon</p>
          )}
        </div>

        <!-- Newsletter Signup -->
        <div style="margin-top: 24px; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15), rgba(240, 147, 251, 0.15)); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 20px; padding: 28px; text-align: center;">
          <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 8px;">Stay Informed</h3>
          <p style="font-size: 14px; color: rgba(255, 255, 255, 0.7); margin-bottom: 16px;">Get PE placement news delivered weekly</p>
          <a href="/contact" style="display: block; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; padding: 12px 24px; border-radius: 50px; text-decoration: none; font-weight: 600; font-size: 14px;">Subscribe ‚Üí</a>
        </div>
      </aside>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <div class="footer-content">
      <div class="footer-section">
        <h3>Placement Quest</h3>
        <p style="color: rgba(255, 255, 255, 0.6); margin-top: 12px;">
          Your definitive private equity placement agents news source.
        </p>
        <p style="margin-top: 16px;">
          <a href="/" style="color: #667eea; text-decoration: none; font-weight: 600;">Top Private Equity Placement Agents</a>
        </p>
      </div>

      <div class="footer-section">
        <h3>Resources</h3>
        <ul class="footer-links">
          <li><a href="/private-equity-placement-agent-news">News</a></li>
          <li><a href="/private-equity-placement-agents-list">Agency Directory</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h3>Company</h3>
        <ul class="footer-links">
          <li><a href="/about">About</a></li>
          <li><a href="/contact">Contact</a></li>
        </ul>
      </div>

      <div class="footer-section">
        <h3>Legal</h3>
        <ul class="footer-links">
          <li><a href="/privacy">Privacy Policy</a></li>
          <li><a href="/terms">Terms & Conditions</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-bottom">
      <p>¬© 2025 Placement. All rights reserved.</p>
    </div>
  </footer>

  <script>
    // Wait for DOM and GSAP to load
    window.addEventListener('load', function() {
      if (typeof gsap !== 'undefined' && typeof ScrollTrigger !== 'undefined') {
        gsap.registerPlugin(ScrollTrigger);

        // Hero animation
        gsap.to('.hero-content', {
          opacity: 1,
          y: 0,
          duration: 1,
          ease: 'power3.out'
        });

        // Article cards staggered animation
        ScrollTrigger.batch('.article-card', {
          onEnter: (elements) => {
            gsap.to(elements, {
              opacity: 1,
              y: 0,
              duration: 0.6,
              stagger: 0.1,
              ease: 'power2.out'
            });
          },
          start: 'top 85%',
          once: true
        });
      }
    });

    // Initialize Mux HLS video for hero
    const heroVideo = document.getElementById('hero-video');
    const heroVideoSrc = 'https://stream.mux.com/D1xxBnkq00yob8i65Q6OXj0173zxoRZFmwyczFUUtmQUY.m3u8';

    function loadHLS(callback) {
      if (typeof Hls !== 'undefined') {
        callback();
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/hls.js@latest';
      script.onload = callback;
      document.head.appendChild(script);
    }

    if (heroVideo) {
      if (heroVideo.canPlayType('application/vnd.apple.mpegurl')) {
        // Native HLS support (Safari)
        heroVideo.src = heroVideoSrc;
        heroVideo.play().catch(() => {});
      } else {
        // Load HLS.js for other browsers
        loadHLS(function() {
          if (typeof Hls !== 'undefined' && Hls.isSupported()) {
            const hls = new Hls({ maxBufferLength: 10 });
            hls.loadSource(heroVideoSrc);
            hls.attachMedia(heroVideo);
            hls.on(Hls.Events.MANIFEST_PARSED, () => heroVideo.play().catch(() => {}));
          }
        });
      }
    }
  </script>
</body>
</html>
